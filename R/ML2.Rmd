---
title: "ML2"
author: "Carla"
date: "2024-04-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(phyloseq)
library(mlr3)
library(mlr3learners)
library(mlr3tuning)
library(mlr3pipelines)
library(ranger)
library(caret)
```

# Experimento 2 - Leave cohort out variable Status (CRC/Control)

```{r include=TRUE}
physeq_output_clr_filtrado <- subset_samples(physeq_output_clr, sample_data(physeq_output_clr)$status != "adenoma")

otu_table <- otu_table(physeq_output_clr_filtrado)
otu_table <- as.matrix(otu_table)
status <- sample_data(physeq_output_clr_filtrado)$status
project <- sample_data(physeq_output_clr_filtrado)$project

data_ml <- cbind(otu_table, status, project)
data_ml <- as.data.frame(data_ml)
data_ml$status <- as.factor(data_ml$status)
data_ml$project <- as.factor(data_ml$project)

for (col in names(data_ml)) {
  if (is.character(data_ml[[col]]) || is.factor(data_ml[[col]])) {
    data_ml[[col]] <- as.numeric(data_ml[[col]])
  }
}

data_ml$status <- as.factor(data_ml$status)
data_ml$project <- as.factor(data_ml$project)

# cancer = 1, normal = 2

# Lo que hay que hacer: leave cohort out es entrenar con 6 cohortes y dejar la 7 para test y así para todas. Por lo tanto, separar data_ml con respecto a las cohortes para tener 6 muestras. La variable que queremos predecir es status (cancer o normal) --> será la que se meta en la task como target. Igual que el experimento anterior pero cambiando el método de resampling para hacerlo con LOCO. 
```

```{r include=TRUE}
num_cohortes <- 7

cohort_indices <- lapply(1:num_cohortes, function(i) which(data_ml$project == i))

folds <- list()

for (i in 1:num_cohortes) {
  test_indices <- cohort_indices[[i]]
  train_indices <- unlist(cohort_indices[-i])
  
  folds[[i]] <- list(train = train_indices, test = test_indices)
}
```

```{r include=TRUE}
task_svm_pre <- TaskClassif$new(id = "ml_loco_svm", backend = data_ml, target = "status")

learner_svm <- lrn("classif.svm")

resampling <- rsmp("custom", folds = folds)

eval_svm_pre <- mlr3::resample(task = task_svm_pre,
                       learner = learner_svm,
                       resampling = resampling)

result_svm_pre_ce <- eval_svm_pre$aggregate(measures=msr("classif.ce"))
result_svm_pre_acc <- eval_svm_pre$aggregate(measures=msr("classif.bacc"))
```